//@version=5
indicator("Tick Data Exporter with Advanced ML Indicators", overlay=false, max_lines_count=500)

// ============================================================================
// 输出配置
// ============================================================================
show_data = input(true, "显示数据窗口")
show_header = input(true, "显示表头")

// ============================================================================
// 基础指标计算函数
// ============================================================================

// RSI 计算
f_rsi(src, len) =>
    up = ta.rma(math.max(ta.change(src), 0), len)
    down = ta.rma(-math.min(ta.change(src), 0), len)
    ta.rsi(src, len)

// MACD 计算
f_macd() =>
    fast_ema = ta.ema(close, 12)
    slow_ema = ta.ema(close, 26)
    macd_line = fast_ema - slow_ema
    signal_line = ta.ema(macd_line, 9)
    [macd_line, signal_line, macd_line - signal_line]

// Stochastic 计算
f_stoch(len) =>
    ll = ta.lowest(low, len)
    hh = ta.highest(high, len)
    k = 100 * (close - ll) / (hh - ll)
    d = ta.sma(k, 3)
    [k, d]

// Bollinger Bands 计算
f_bb(src, len, mult) =>
    basis = ta.sma(src, len)
    dev = mult * ta.stdev(src, len)
    [basis - dev, basis, basis + dev]

// ATR 计算
f_atr(len) =>
    ta.atr(len)

// ============================================================================
// 高级ML指标
// ============================================================================

// 1. 流动性失衡指数 (Liquidity Imbalance Index)
f_lii(len) =>
    // 衡量买卖压力失衡
    buy_pressure = (close - low) / (high - low + 0.0001)
    sell_pressure = (high - close) / (high - low + 0.0001)
    imbalance = math.abs(buy_pressure - sell_pressure)
    lii = ta.rma(imbalance * 100, len)
    math.min(math.max(lii, 0), 100)

// 2. 多时间框架共鸣指数 (Multi-Timeframe Resonance Index)
f_mtri(len) =>
    // 不同周期RSI的协同强度
    rsi14 = ta.rsi(close, 14)
    rsi7 = ta.rsi(close, 7)
    rsi21 = ta.rsi(close, 21)
    // 计算RSI之间的相关性强度
    correlation = math.abs(rsi14 - 50) + math.abs(rsi7 - 50) + math.abs(rsi21 - 50)
    mtri = correlation / 3
    math.min(math.max(mtri, 0), 100)

// 3. 动态支撑阻力破裂指数 (Dynamic Support-Resistance Fractal Index)
f_dsrfi(len) =>
    // 衡量趋势强度和破裂可能性
    atr_val = ta.atr(14)
    volatility = atr_val / close * 100
    
    // 分形维度估计 (简化版)
    up_count = 0.0
    down_count = 0.0
    for i = 1 to len by 1
        if close[i] > close[i + 1]
            up_count += 1
        else
            down_count += 1
    
    trend_strength = (up_count - down_count) / len * 100
    dsrfi = math.abs(trend_strength) + (volatility / 2)
    math.min(math.max(dsrfi, 0), 100)

// ============================================================================
// 主指标计算
// ============================================================================

// 基础指标
rsi_val = ta.rsi(close, 14)
[stoch_k, stoch_d] = f_stoch(14)
[macd_line, signal_line, macd_hist] = f_macd()
[bb_lower, bb_basis, bb_upper] = f_bb(close, 20, 2)
atr_val = f_atr(14)

// 自创指标
momentum_confluence = (rsi_val - 50) + ((stoch_k - 50) / 2)
volatility_expansion = (atr_val / ta.sma(atr_val, 20)) * 100 - 100
rsi_convergence = math.abs(rsi_val - stoch_k) / 100 * 50
composite_signal = (momentum_confluence + (volatility_expansion / 2)) / 2

// 高级ML指标
lii = f_lii(14)
mtri = f_mtri(14)
dsrfi = f_dsrfi(14)

// ============================================================================
// 数据格式化为CSV
// ============================================================================

// 表头行
header = show_header ? "DateTime,Open,High,Low,Close,Volume,RSI,StochK,StochD,MACD,Signal,MacdHist,BBupper,BBbasis,BBlower,ATR,Momentum,Volatility,RSIconv,Composite,LII,MTRI,DSRFI" : ""

// 数据行 - 单行格式（不换行）
csv_data = str.format("{0},{1},{2},{3},{4},{5},{6},{7},{8},{9},{10},{11},{12},{13},{14},{15},{16},{17},{18},{19},{20},{21},{22}", str.tostring(time), str.tostring(math.round(open, 5)), str.tostring(math.round(high, 5)), str.tostring(math.round(low, 5)), str.tostring(math.round(close, 5)), str.tostring(volume), str.tostring(math.round(rsi_val, 2)), str.tostring(math.round(stoch_k, 2)), str.tostring(math.round(stoch_d, 2)), str.tostring(math.round(macd_line, 4)), str.tostring(math.round(signal_line, 4)), str.tostring(math.round(macd_hist, 4)), str.tostring(math.round(bb_upper, 5)), str.tostring(math.round(bb_basis, 5)), str.tostring(math.round(bb_lower, 5)), str.tostring(math.round(atr_val, 4)), str.tostring(math.round(momentum_confluence, 2)), str.tostring(math.round(volatility_expansion, 2)), str.tostring(math.round(rsi_convergence, 2)), str.tostring(math.round(composite_signal, 2)), str.tostring(math.round(lii, 2)), str.tostring(math.round(mtri, 2)), str.tostring(math.round(dsrfi, 2)))

// ============================================================================
// 绘图显示
// ============================================================================

// 显示CSI Momentum
plot(momentum_confluence, "Momentum", color.new(color.blue, 0), linewidth=2)
plot(0, "Zero Line", color.gray)

// 显示RSI
plot(rsi_val, "RSI", color.new(color.orange, 0), linewidth=1)

// 显示高级指标
plot(lii, "LII", color.new(color.green, 50), linewidth=1)
plot(mtri, "MTRI", color.new(color.red, 50), linewidth=1)
plot(dsrfi, "DSRFI", color.new(color.purple, 50), linewidth=1)

// ============================================================================
// 数据输出到表格
// ============================================================================

if show_data
    // 显示表头
    if show_header and barstate.isfirst
        var table data_table = table.new(position.top_right, 24, 2, border_color=color.gray, frame_color=color.blue, frame_width=2)
        table.cell(data_table, 0, 0, "Data Export", text_color=color.white, bgcolor=color.blue)
        table.cell(data_table, 0, 1, header, text_color=color.white, bgcolor=color.gray)
    
    // 显示当前数据行
    if not barstate.isfirst
        var table data_table2 = table.new(position.top_right, 24, 2, border_color=color.gray)
        table.cell(data_table2, 0, 0, "Current Bar", text_color=color.white, bgcolor=color.blue)
        table.cell(data_table2, 0, 1, csv_data, text_color=color.lime, bgcolor=color.black, text_halign=text.align_left)

// ============================================================================
// 告知用户的警告信息
// ============================================================================

if barstate.islast
    alert_msg = "Tick Data Ready! Copy from Data Window (Ctrl+Shift+D). Visit github.com/caizongxun/ML-Trading-Indicator for more info."
    alert(alert_msg)
