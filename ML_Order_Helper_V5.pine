//@version=5
indicator("ML Order Helper - Pending Order Placement & ML Training Data", overlay=false, max_bars_back=500)

// ============================================================================
// SECTION 1: 基礎指標輸入參數
// ============================================================================

rsi_src = input(close, title="RSI Source", group="RSI Settings")
rsi_length = input.int(14, title="RSI Length", minval=2, maxval=100, group="RSI Settings")

bb_src = input(close, title="BB Source", group="Bollinger Bands")
bb_length = input.int(20, title="BB Length", minval=1, maxval=500, group="Bollinger Bands")
bb_mult = input.float(2.0, title="BB StdDev", minval=0.1, maxval=5, step=0.1, group="Bollinger Bands")

macd_fast = input.int(12, title="MACD Fast", minval=1, maxval=100, group="MACD Settings")
macd_slow = input.int(26, title="MACD Slow", minval=1, maxval=100, group="MACD Settings")
macd_signal = input.int(9, title="MACD Signal", minval=1, maxval=100, group="MACD Settings")

stoch_k = input.int(14, title="Stoch %K", minval=1, maxval=100, group="Stochastic Settings")
stoch_d = input.int(3, title="Stoch %D", minval=1, maxval=100, group="Stochastic Settings")
stoch_smooth = input.int(3, title="Stoch Smooth", minval=1, maxval=100, group="Stochastic Settings")

atr_length = input.int(14, title="ATR Length", minval=1, maxval=100, group="ATR Settings")

sr_lookback = input.int(5, title="S/R Lookback Bars", minval=2, maxval=50, group="Support/Resistance")
sr_sensitivity = input.float(0.3, title="S/R Sensitivity (%)", minval=0.1, maxval=5.0, step=0.1, group="Support/Resistance")

show_base_indicators = input.bool(true, title="Show Base Indicators", group="Display")
show_custom_indicators = input.bool(true, title="Show Custom Indicators", group="Display")
show_order_levels = input.bool(true, title="Show Pending Order Levels", group="Display")
show_ml_data = input.bool(true, title="Show ML Data Table", group="Display")

// ============================================================================
// SECTION 2: 計算基礎指標
// ============================================================================

rsi_val = ta.rsi(rsi_src, rsi_length)

bb_basis = ta.ema(bb_src, bb_length)
bb_dev = bb_mult * ta.stdev(bb_src, bb_length)
bb_upper = bb_basis + bb_dev
bb_lower = bb_basis - bb_dev

[macd_line, signal_line, macd_hist] = ta.macd(close, macd_fast, macd_slow, macd_signal)

stoch_high = ta.highest(high, stoch_k)
stoch_low = ta.lowest(low, stoch_k)
stoch_raw_k = 100 * (close - stoch_low) / (stoch_high - stoch_low)
stoch_k_val = ta.sma(stoch_raw_k, stoch_smooth)
stoch_d_val = ta.sma(stoch_k_val, stoch_d)

atr_val = ta.atr(atr_length)

// ============================================================================
// SECTION 3: 計算自創指標
// ============================================================================

momentum_confluence = 0.0
if rsi_val > 70
    momentum_confluence += 33.33
if stoch_k_val > 80
    momentum_confluence += 33.33
if macd_line > signal_line and macd_hist > 0
    momentum_confluence += 33.33

if rsi_val < 30
    momentum_confluence -= 33.33
if stoch_k_val < 20
    momentum_confluence -= 33.33
if macd_line < signal_line and macd_hist < 0
    momentum_confluence -= 33.33

momentum_confluence := math.max(-100, math.min(100, momentum_confluence))

bb_width = bb_upper - bb_lower
bb_width_sma = ta.sma(bb_width, 20)
volatility_expansion = math.min(100, (bb_width / bb_width_sma) * 50)

price_in_bands = 50.0
if bb_upper != bb_lower
    price_in_bands := ((close - bb_lower) / (bb_upper - bb_lower)) * 100
price_in_bands := math.max(0, math.min(100, price_in_bands))

rsi_bb_basis = ta.ema(rsi_val, bb_length)
rsi_bb_dev = bb_mult * ta.stdev(rsi_val, bb_length)
rsi_bb_upper = rsi_bb_basis + rsi_bb_dev
rsi_bb_lower = rsi_bb_basis - rsi_bb_dev
rsi_dispersion_zone = ((rsi_bb_upper - rsi_bb_lower) * 0.1)
rsi_above_upper = rsi_val > (rsi_bb_basis + rsi_dispersion_zone) ? 100 : 0
rsi_below_lower = rsi_val < (rsi_bb_basis - rsi_dispersion_zone) ? 100 : 0
rsi_convergence = (rsi_above_upper + rsi_below_lower) / 2

composite_signal = (momentum_confluence + volatility_expansion + rsi_convergence) / 3

// ============================================================================
// SECTION 4: 支撐/阻力檢測 & 掛單點位計算
// ============================================================================

pivot_high = ta.pivothigh(high, sr_lookback, sr_lookback)
pivot_low = ta.pivotlow(low, sr_lookback, sr_lookback)

recent_high = ta.highest(high, sr_lookback * 2)
recent_low = ta.lowest(low, sr_lookback * 2)

pending_offset = atr_val * 0.5

buy_pending_level = recent_low - pending_offset
sell_pending_level = recent_high + pending_offset

buy_stop_loss = buy_pending_level - (atr_val * 1.0)
sell_stop_loss = sell_pending_level + (atr_val * 1.0)

buy_take_profit = sell_pending_level
sell_take_profit = buy_pending_level

// ============================================================================
// SECTION 5: ML 訓練數據準備
// ============================================================================

normalize(val, min_val, max_val) =>
    if max_val == min_val
        0.5
    else
        math.max(0, math.min(1, (val - min_val) / (max_val - min_val)))

rsi_normalized = normalize(rsi_val, 0, 100)
stoch_normalized = normalize(stoch_k_val, 0, 100)
momentum_normalized = normalize(momentum_confluence, -100, 100)
volatility_normalized = normalize(volatility_expansion, 0, 100)
price_position_normalized = normalize(price_in_bands, 0, 100)
convergence_normalized = normalize(rsi_convergence, 0, 100)
composite_normalized = normalize(composite_signal, 0, 100)

order_filled = 0.0
order_profitable = 0.0

// ============================================================================
// SECTION 6: 繪圖
// ============================================================================

plot(show_base_indicators ? rsi_val : na, title="RSI", color=color.blue, linewidth=2)
hline(70, color=color.gray, linestyle=hline.style_dotted, linewidth=1, title="RSI Upper")
hline(30, color=color.gray, linestyle=hline.style_dotted, linewidth=1, title="RSI Lower")
plot(show_base_indicators ? bb_basis : na, title="BB Basis", color=color.orange)
plot(show_base_indicators ? bb_upper : na, title="BB Upper", color=color.aqua, linewidth=2)
plot(show_base_indicators ? bb_lower : na, title="BB Lower", color=color.aqua, linewidth=2)

plot(show_custom_indicators ? momentum_confluence : na, title="Momentum Confluence", color=color.new(color.green, 30), linewidth=2)
plot(show_custom_indicators ? volatility_expansion : na, title="Volatility Expansion", color=color.new(color.red, 30), linewidth=2)
plot(show_custom_indicators ? rsi_convergence : na, title="RSI Convergence", color=color.new(color.purple, 30), linewidth=2)
plot(show_custom_indicators ? composite_signal : na, title="Composite Signal", color=color.new(color.yellow, 0), linewidth=3)

plot(show_order_levels ? buy_pending_level : na, title="Buy Pending Level", color=color.lime, linewidth=2)
plot(show_order_levels ? sell_pending_level : na, title="Sell Pending Level", color=color.red, linewidth=2)

// 使用 line.new() 繪製虛線 (plot() 不支援虛線)
var buy_tp_line = line.new(na, na, na, na, extend=extend.right, style=line.style_dashed, color=color.new(color.lime, 50), width=1)
var sell_tp_line = line.new(na, na, na, na, extend=extend.right, style=line.style_dashed, color=color.new(color.red, 50), width=1)

if show_order_levels
    line.set_xy1(buy_tp_line, bar_index, buy_take_profit)
    line.set_xy2(buy_tp_line, bar_index, buy_take_profit)
    
    line.set_xy1(sell_tp_line, bar_index, sell_take_profit)
    line.set_xy2(sell_tp_line, bar_index, sell_take_profit)

// ============================================================================
// SECTION 7: ML 數據表格顯示
// ============================================================================

if show_ml_data
    var table ml_table = table.new(position.top_right, 2, 15, border_color=color.gray, border_width=1)
    
    table.cell(ml_table, 0, 0, "Base Indicators", text_color=color.white, bgcolor=color.new(color.blue, 60))
    table.cell(ml_table, 1, 0, "Value", text_color=color.white, bgcolor=color.new(color.blue, 60))
    
    table.cell(ml_table, 0, 1, "RSI", text_color=color.white, bgcolor=color.new(color.gray, 60))
    table.cell(ml_table, 1, 1, str.tostring(math.round(rsi_val, 2)), text_color=color.white, bgcolor=color.new(color.gray, 60))
    
    table.cell(ml_table, 0, 2, "Stoch %K", text_color=color.white, bgcolor=color.new(color.gray, 60))
    table.cell(ml_table, 1, 2, str.tostring(math.round(stoch_k_val, 2)), text_color=color.white, bgcolor=color.new(color.gray, 60))
    
    table.cell(ml_table, 0, 3, "MACD", text_color=color.white, bgcolor=color.new(color.gray, 60))
    table.cell(ml_table, 1, 3, str.tostring(math.round(macd_line, 2)), text_color=color.white, bgcolor=color.new(color.gray, 60))
    
    table.cell(ml_table, 0, 4, "BB Width", text_color=color.white, bgcolor=color.new(color.gray, 60))
    table.cell(ml_table, 1, 4, str.tostring(math.round(bb_width, 4)), text_color=color.white, bgcolor=color.new(color.gray, 60))
    
    table.cell(ml_table, 0, 5, "Custom Indicators", text_color=color.white, bgcolor=color.new(color.green, 60))
    table.cell(ml_table, 1, 5, "Value", text_color=color.white, bgcolor=color.new(color.green, 60))
    
    table.cell(ml_table, 0, 6, "Momentum Score", text_color=color.white, bgcolor=color.new(color.gray, 60))
    table.cell(ml_table, 1, 6, str.tostring(math.round(momentum_confluence, 2)), text_color=color.white, bgcolor=color.new(color.gray, 60))
    
    table.cell(ml_table, 0, 7, "Volatility Index", text_color=color.white, bgcolor=color.new(color.gray, 60))
    table.cell(ml_table, 1, 7, str.tostring(math.round(volatility_expansion, 2)), text_color=color.white, bgcolor=color.new(color.gray, 60))
    
    table.cell(ml_table, 0, 8, "RSI Convergence", text_color=color.white, bgcolor=color.new(color.gray, 60))
    table.cell(ml_table, 1, 8, str.tostring(math.round(rsi_convergence, 2)), text_color=color.white, bgcolor=color.new(color.gray, 60))
    
    table.cell(ml_table, 0, 9, "Composite Signal", text_color=color.white, bgcolor=color.new(color.gray, 60))
    table.cell(ml_table, 1, 9, str.tostring(math.round(composite_signal, 2)), text_color=color.white, bgcolor=color.new(color.gray, 60))
    
    table.cell(ml_table, 0, 10, "Order Levels", text_color=color.white, bgcolor=color.new(color.orange, 60))
    table.cell(ml_table, 1, 10, "Price", text_color=color.white, bgcolor=color.new(color.orange, 60))
    
    table.cell(ml_table, 0, 11, "Buy Pending", text_color=color.white, bgcolor=color.new(color.gray, 60))
    table.cell(ml_table, 1, 11, str.tostring(math.round(buy_pending_level, 2)), text_color=color.white, bgcolor=color.new(color.gray, 60))
    
    table.cell(ml_table, 0, 12, "Sell Pending", text_color=color.white, bgcolor=color.new(color.gray, 60))
    table.cell(ml_table, 1, 12, str.tostring(math.round(sell_pending_level, 2)), text_color=color.white, bgcolor=color.new(color.gray, 60))
    
    table.cell(ml_table, 0, 13, "Buy Stop Loss", text_color=color.white, bgcolor=color.new(color.gray, 60))
    table.cell(ml_table, 1, 13, str.tostring(math.round(buy_stop_loss, 2)), text_color=color.white, bgcolor=color.new(color.gray, 60))
    
    table.cell(ml_table, 0, 14, "Sell Stop Loss", text_color=color.white, bgcolor=color.new(color.gray, 60))
    table.cell(ml_table, 1, 14, str.tostring(math.round(sell_stop_loss, 2)), text_color=color.white, bgcolor=color.new(color.gray, 60))

// ============================================================================
// SECTION 8: 警報和信號
// ============================================================================

buy_signal = composite_signal < -50 and rsi_val < 30 and stoch_k_val < 20
sell_signal = composite_signal > 50 and rsi_val > 70 and stoch_k_val > 80

alertcondition(buy_signal, title="BUY Pending Order Setup", message="Buy pending order setup identified at {{close}}")
alertcondition(sell_signal, title="SELL Pending Order Setup", message="Sell pending order setup identified at {{close}}")
